<!DOCTYPE html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Klik & Belajar (Warna & Saiz) ‚Äî Mesra Akses + TTS Stabil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .bounce { animation: bounce 0.5s ease-in-out; }
    @keyframes bounce { 0%,20%,60%,100%{transform:translateY(0)} 40%{transform:translateY(-10px)} 80%{transform:translateY(-5px)} }
    /* Highlight info bar when text changes */
    @keyframes highlight { 0% { background-color:#fde68a; } 100%{ background-color:#fef3c7; } }
    .animate-highlight { animation: highlight 900ms ease-in-out; }
  </style>
</head>
<body class="h-full bg-blue-50 font-sans">
  <!-- Header -->
  <header class="bg-white shadow-sm p-4 mb-4">
    <h1 class="text-xl md:text-2xl font-bold text-center text-blue-700">
      Kemahiran Pemulihan: Klik & Belajar (Warna & Saiz)
    </h1>
  </header>

  <div class="max-w-4xl mx-auto px-4">
    <!-- Main Card -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
      <div id="mainContent"></div>
    </div>

    <!-- Info Bar (mesra akses) -->
    <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
      <div id="infoBarWrapper"
           class="flex items-center justify-between gap-3 bg-amber-100 border border-amber-300 rounded-lg py-3 px-4 shadow-sm">
        <div id="infoBar"
             class="text-xl md:text-2xl font-extrabold text-gray-900 tracking-wide">
          üí° Klik mana-mana elemen untuk belajar.
        </div>
        <button id="repeatBtn" title="Baca semula"
                class="text-3xl md:text-4xl leading-none hover:scale-110 transition"
                onclick="repeatSpeech()">üîä</button>
      </div>
    </div>

    <!-- Activity Menu -->
    <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
      <h3 class="font-bold text-gray-700 mb-3">Pilih Aktiviti:</h3>
      <div id="activityButtons" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
    </div>

    <!-- Footer Buttons -->
    <div class="flex gap-2 pb-6">
      <button class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-bold" onclick="resetActivity()">üîÑ Bersih</button>
      <button class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold" onclick="nextActivity()">‚û°Ô∏è Seterusnya</button>
    </div>
  </div>

  <script>
    /* ================== DATA ================== */
    const colors = [
      { name: 'Merah', bg: 'bg-red-500', emoji:'üî¥' },
      { name: 'Biru',  bg: 'bg-blue-500', emoji:'üîµ' },
      { name: 'Hijau', bg: 'bg-green-500', emoji:'üü¢' },
      { name: 'Kuning',bg: 'bg-yellow-400', emoji:'üü°' }
    ];
    const items = [
      { name:'Pisang', color:'Kuning', emoji:'üçå' },
      { name:'Epal',   color:'Merah',  emoji:'üçé' },
      { name:'Daun',   color:'Hijau',  emoji:'üçÉ' },
      { name:'Awan',   color:'Putih',  emoji:'‚òÅÔ∏è' }
    ];

    /* ============== TTS stabil + mesra browser ============== */
    let lastSpoken = "";
    let lastIcon = "üí°";

    const TTS = { ready:false, voices:[], voice:null, queue:[], unlocked:false };

    function pickVoice() {
      const pref = ["ms-MY","ms_MY","id-ID","id_ID","en-GB","en_US","en-US"];
      for (const code of pref) {
        const v = TTS.voices.find(v => v.lang === code);
        if (v) return v;
      }
      return TTS.voices[0] || null;
    }

    function flushQueue() {
      if (!TTS.ready || !TTS.unlocked) return;
      while (TTS.queue.length) _speakNow(TTS.queue.shift());
    }

    function initTTS() {
      const synth = window.speechSynthesis;

      function loadVoices() {
        TTS.voices = synth.getVoices();
        if (TTS.voices.length) {
          TTS.voice = pickVoice();
          TTS.ready = true;
          flushQueue();
        }
      }
      synth.addEventListener("voiceschanged", loadVoices);
      loadVoices();

      // Unlock selepas interaksi pertama (atasi autoplay)
      const unlock = () => {
        if (!TTS.unlocked) {
          try { synth.cancel(); synth.resume(); } catch {}
          TTS.unlocked = true;
          flushQueue();
        }
      };
      window.addEventListener("pointerdown", unlock, { once:true });
      window.addEventListener("keydown", unlock, { once:true });

      // Chrome kadang auto-pause ‚Üí pulse resume sekejap
      const tick = setInterval(()=>{ try{ synth.resume(); }catch{} }, 1000);
      setTimeout(()=>clearInterval(tick), 5000);
    }

    function _speakNow(text) {
      const synth = window.speechSynthesis;
      const msg = new SpeechSynthesisUtterance();
      msg.text = text;
      msg.lang = (TTS.voice && TTS.voice.lang) || "ms-MY";
      msg.voice = TTS.voice || null;
      msg.rate = 0.75; msg.pitch = 1; msg.volume = 1;

      if (synth.speaking) { try { synth.cancel(); } catch {} }
      try { synth.speak(msg); } catch {}
    }

    function speak(text) {
      lastSpoken = text;
      if (!TTS.ready || !TTS.unlocked) { TTS.queue.push(text); return; }
      _speakNow(text);
    }

    function repeatSpeech(){ if (lastSpoken) speak(lastSpoken); }

    // Info bar + (opsyenal) suara, dengan highlight
function say(text, icon = "üí°", speakNow = true) {
  lastIcon = icon;
  const el = document.getElementById("infoBar");
  el.innerHTML = `${icon} ${text}`;
  el.classList.remove("animate-highlight");
  void el.offsetWidth; // reset animasi
  el.classList.add("animate-highlight");

  // Simpan teks terakhir untuk butang üîä
  lastSpoken = text;

  // Hanya baca jika dibenarkan
  if (speakNow) speak(text);
}


    /* ============== STATE & AKTIVITI ============== */
    let currentActivity = 0;

    const activities = [
      { name:'Kenal Warna',            func: showColorLearn },
      { name:'Benda & Warna',          func: showItemColorLearn },
      { name:'Mewarna (Klik Bintang)', func: showFreeColoring },
      { name:'Kenal Saiz',             func: showSizeLearn },
      { name:'Banding Saiz',           func: showSizeCompareLearn },
      { name:'Eksplorasi Saiz & Warna',func: showSizeExplore }
    ];

    function init(){
      initTTS();                // <<‚Äî aktifkan TTS stabil
      loadActivityButtons();
      loadActivity(0);
    }

    function loadActivityButtons(){
      const container = document.getElementById('activityButtons');
      container.innerHTML = activities.map((a,i)=>`
        <button onclick="loadActivity(${i})"
          class="p-3 rounded-lg font-bold text-sm transition-colors ${i===currentActivity?'bg-blue-500 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
          ${i+1}. ${a.name}
        </button>`).join('');
    }

    function loadActivity(i){
      currentActivity = i;
      activities[i].func();
      say('Klik mana-mana elemen untuk belajar.', 'üí°', false);
      document.getElementById('mainContent').classList.add('bounce');
      setTimeout(()=>document.getElementById('mainContent').classList.remove('bounce'),500);
      loadActivityButtons();
    }

    function resetActivity(){ loadActivity(currentActivity); }
    function nextActivity(){ currentActivity = (currentActivity + 1) % activities.length; loadActivity(currentActivity); }

    /* ============== AKTIVITI WARNA ============== */
    function showColorLearn(){
      document.getElementById('mainContent').innerHTML = `
        <h2 class="text-xl font-bold text-center mb-6">Kenal Warna</h2>
        <p class="text-center mb-4">Klik warna untuk tahu namanya.</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          ${colors.map(c=>`
            <button class="p-8 ${c.bg} rounded-lg hover:scale-105 transition-transform text-white font-bold"
                    onclick="say('Ini warna ${c.name}.','üé®');">
              <div class="text-4xl mb-2">${c.emoji}</div>${c.name}
            </button>`).join('')}
        </div>`;
    }

    function showItemColorLearn(){
      document.getElementById('mainContent').innerHTML = `
        <h2 class="text-xl font-bold text-center mb-6">Benda & Warna</h2>
        <p class="text-center mb-4">Klik gambar untuk tahu warna biasa bagi benda itu.</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          ${items.map(it=>`
            <button class="p-6 bg-gray-50 hover:bg-gray-100 rounded-lg border"
                    onclick="say('${it.name} berwarna ${it.color}.','üé®');">
              <div class="text-5xl mb-2">${it.emoji}</div>
              <div class="font-bold">${it.name}</div>
            </button>`).join('')}
        </div>`;
    }

    function showFreeColoring(){
      document.getElementById('mainContent').innerHTML = `
        <h2 class="text-xl font-bold text-center mb-6">Mewarna (Klik Bintang)</h2>
        <p class="text-center mb-4">Pilih warna, kemudian klik bintang untuk mewarnakannya.</p>
        <div class="text-center mb-6">
          <svg width="140" height="140" class="mx-auto">
            <polygon id="star" points="70,12 82,48 118,48 89,68 100,104 70,82 40,104 51,68 22,48 58,48"
              fill="white" stroke="black" stroke-width="2"
              class="cursor-pointer hover:opacity-90"/>
          </svg>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          ${colors.map(c=>`
            <button class="p-3 ${c.bg} rounded-lg text-white font-bold"
                    onclick="selectPaint('${c.name}')">${c.name}</button>`).join('')}
        </div>`;
      window.selectedPaint = null;
      document.getElementById('star').addEventListener('click', ()=>{
        if(!window.selectedPaint){ say('Pilih warna dahulu.','üé®'); return; }
        document.getElementById('star').setAttribute('fill', paintToFill(window.selectedPaint));
        say(`Bintang diwarnakan dengan warna ${window.selectedPaint}.`, 'üé®');
      });
    }
    function selectPaint(name){ window.selectedPaint = name; say(`Warna ${name} dipilih.`, 'üé®'); }
    function paintToFill(name){
      switch(name){
        case 'Merah': return '#ef4444';
        case 'Biru' : return '#3b82f6';
        case 'Hijau': return '#22c55e';
        case 'Kuning':return '#facc15';
        default: return 'white';
      }
    }

    /* ============== AKTIVITI SAIZ ============== */
    function showSizeLearn(){
      document.getElementById('mainContent').innerHTML = `
        <h2 class="text-xl font-bold text-center mb-6">Kenal Saiz</h2>
        <p class="text-center mb-4">Klik untuk lihat nama saiz.</p>
        <div class="flex justify-center items-end gap-10">
          <button class="p-4 bg-blue-500 rounded-lg text-white font-bold"
                  onclick="say('Ini saiz kecil.','üìè');">
            <div class="w-8 h-8 bg-white rounded-full mx-auto mb-2"></div>Kecil
          </button>
          <button class="p-6 bg-blue-500 rounded-lg text-white font-bold"
                  onclick="say('Ini saiz besar.','üìè');">
            <div class="w-16 h-16 bg-white rounded-full mx-auto mb-2"></div>Besar
          </button>
        </div>`;
    }

    function showSizeCompareLearn(){
      document.getElementById('mainContent').innerHTML = `
        <h2 class="text-xl font-bold text-center mb-6">Banding Saiz</h2>
        <p class="text-center mb-4">Klik mana-mana untuk belajar konsep besar & kecil.</p>
        <div class="flex justify-center items-end gap-12 mb-4">
          <button class="p-4 bg-gray-100 rounded-lg"
                  onclick="say('Semut lebih kecil berbanding gajah.','üìè');">
            <div class="text-5xl">üêú</div><div class="mt-2">Kecil</div>
          </button>
          <button class="p-4 bg-gray-100 rounded-lg"
                  onclick="say('Gajah lebih besar berbanding semut.','üìè');">
            <div class="text-8xl">üêò</div><div class="mt-2">Besar</div>
          </button>
        </div>`;
    }

    function showSizeExplore(){
      const colorMap = { Merah:'#ef4444', Biru:'#3b82f6', Hijau:'#22c55e', Kuning:'#facc15' };

      document.getElementById('mainContent').innerHTML = `
        <h2 class="text-xl font-bold text-center mb-6">Eksplorasi Saiz & Warna</h2>
        <p class="text-center mb-4">Laraskan saiz, tukar bentuk & warna. Klik untuk dengar sebutan.</p>

        <div class="flex flex-col items-center gap-5">
          <div id="demoShape" class="shadow inline-block"
               style="width:48px;height:48px;border-radius:9999px;background:#3b82f6"></div>

          <div class="text-sm text-gray-700">
            <span>Saiz: </span><span id="sizeLabel" class="font-semibold">Sederhana</span>
            <span class="mx-2">|</span>
            <span>Bentuk: </span><span id="shapeLabel" class="font-semibold">Bulat</span>
            <span class="mx-2">|</span>
            <span>Warna: </span><span id="colorLabel" class="font-semibold">Biru</span>
          </div>

          <div class="w-full max-w-md">
            <input id="sizeSlider" type="range" min="24" max="120" value="48" class="w-full accent-blue-600">
            <div class="mt-1 text-center text-xs text-gray-600">Seret pemegang untuk ubah saiz</div>
          </div>

          <div class="flex gap-2">
            <button class="px-3 py-2 rounded bg-green-100 hover:bg-green-200"  onclick="snapSize('kecil')">Kecil</button>
            <button class="px-3 py-2 rounded bg-yellow-100 hover:bg-yellow-200" onclick="snapSize('sederhana')">Sederhana</button>
            <button class="px-3 py-2 rounded bg-red-100 hover:bg-red-200"     onclick="snapSize('besar')">Besar</button>
          </div>

          <div class="flex items-center gap-2 mt-2">
            <span class="text-sm text-gray-600">Bentuk:</span>
            <button class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" onclick="setShape('Bulat')">Bulat</button>
            <button class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300" onclick="setShape('Segi Empat')">Segi Empat</button>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">Warna:</span>
            ${Object.entries(colorMap).map(([n,hex]) => `
              <button class="w-8 h-8 rounded-full border" style="background:${hex}" title="${n}"
                      onclick="setColor('${n}')"></button>
            `).join('')}
          </div>
        </div>`;

      const shapeEl = document.getElementById('demoShape');
      const sizeLab = document.getElementById('sizeLabel');
      const shapeLab = document.getElementById('shapeLabel');
      const colorLab = document.getElementById('colorLabel');
      const slider  = document.getElementById('sizeSlider');

      function sizeToLabel(px){ if(px<40) return 'Kecil'; if(px>80) return 'Besar'; return 'Sederhana'; }
      function updateSize(px){
        shapeEl.style.width = px+'px'; shapeEl.style.height = px+'px';
        const label = sizeToLabel(px);
        sizeLab.textContent = label; say(`Ini saiz ${label.toLowerCase()}.`, 'üìè');
      }
      slider.addEventListener('input', e => updateSize(parseInt(e.target.value,10)));

      window.snapSize = (mode)=>{ const preset = mode==='kecil'?28 : mode==='besar'?100 : 60; slider.value = preset; updateSize(preset); };
      window.setShape = (name)=>{ shapeEl.style.borderRadius = (name==='Bulat')?'9999px':'0px'; shapeLab.textContent=name; say(`Bentuk ${name.toLowerCase()}.`, 'üî∫'); };
      window.setColor = (name)=>{ shapeEl.style.background = colorMap[name]; colorLab.textContent=name; say(`Warna ${name.toLowerCase()}.`, 'üé®'); };

      updateSize(48); window.setShape('Bulat'); window.setColor('Biru');
    }

    // GO!
    init();
  </script>
</body>
</html>
